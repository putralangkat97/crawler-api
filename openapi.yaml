openapi: 3.0.3
info:
  title: Scraper API
  version: 2.0.0
  description: Production-grade scraping and crawling API with R2 storage, async queue-based crawling, and secure SSRF protection.

servers:
  - url: http://localhost:8000/api
    description: Local development
  - url: https://api.example.com/api
    description: Production

security:
  - ApiKeyAuth: []

paths:
  /health:
    get:
      summary: Health check
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /ready:
    get:
      summary: Readiness check
      security: []
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /v1/scrape:
    post:
      summary: Scrape one or more URLs (synchronous)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - url
              properties:
                url:
                  oneOf:
                    - type: string
                      format: uri
                    - type: array
                      items:
                        type: string
                        format: uri
                  example: https://example.com
                request:
                  type: string
                  enum: [http, chrome, smart]
                  default: smart
                  description: Request type (http=fast, chrome=JS, smart=auto-detect)
                return_format:
                  type: string
                  enum: [markdown, commonmark, raw, text, xml, bytes, empty]
                  default: markdown
                metadata:
                  type: boolean
                  default: false
                session:
                  type: boolean
                  default: false
                scroll:
                  type: integer
                  minimum: 0
                  maximum: 30000
                  description: Scroll duration in ms (chrome only)
                wait_for:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                        enum: [selector]
                      selector:
                        type: string
                      timeout_ms:
                        type: integer
                  description: Wait actions (chrome only)
                timeout_ms:
                  type: integer
                  minimum: 1000
                  maximum: 120000
                  default: 8000
                max_bytes:
                  type: integer
                  minimum: 1024
                  maximum: 50000000
                  default: 15000000
      responses:
        '200':
          description: Scrape results
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ScrapeResult'

  /v1/crawl:
    post:
      summary: Start async crawl (enqueues job)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - url
              properties:
                url:
                  type: string
                  format: uri
                  example: https://example.com
                limit:
                  type: integer
                  minimum: 0
                  maximum: 1000
                  default: 0
                  description: Max pages (0=default cap)
                depth:
                  type: integer
                  minimum: 0
                  maximum: 100
                  default: 25
                request:
                  type: string
                  enum: [http, chrome, smart]
                  default: smart
                return_format:
                  type: string
                  enum: [markdown, commonmark, raw, text, xml, bytes, empty]
                  default: markdown
                metadata:
                  type: boolean
                  default: false
                session:
                  type: boolean
                  default: false
                scroll:
                  type: integer
                wait_for:
                  type: array
                  items:
                    type: object
                timeout_ms:
                  type: integer
                max_bytes:
                  type: integer
                same_domain_only:
                  type: boolean
                  default: true
                allow_patterns:
                  type: array
                  items:
                    type: string
                  description: Regex patterns to allow
                deny_patterns:
                  type: array
                  items:
                    type: string
                  description: Regex patterns to deny
                include_pdf:
                  type: boolean
                  default: true
                polite:
                  type: object
                  properties:
                    concurrency:
                      type: integer
                      default: 3
                    per_host_delay_ms:
                      type: integer
                      default: 1200
                    jitter_ratio:
                      type: number
                      format: float
                      default: 0.3
                    max_errors:
                      type: integer
                      default: 25
                    max_retries:
                      type: integer
                      default: 3
      responses:
        '200':
          description: Crawl job created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  job_id:
                    type: string
                    example: crawl_9c5e8a12-3456-7890-abcd-ef1234567890

  /v1/crawl/{job_id}:
    get:
      summary: Get crawl job status
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job status
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      job_id:
                        type: string
                      status:
                        type: string
                        enum: [queued, running, completed, failed, canceled]
                      created_at:
                        type: string
                        format: date-time
                      updated_at:
                        type: string
                        format: date-time
                      canceled_at:
                        type: string
                        format: date-time
                        nullable: true
                      error:
                        type: object
                        nullable: true
    delete:
      summary: Cancel crawl job
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job canceled
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true

  /v1/crawl/{job_id}/results:
    get:
      summary: Get crawl results (cursor-based pagination)
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: string
        - name: cursor
          in: query
          required: false
          schema:
            type: string
            nullable: true
          description: Pagination cursor (base64 encoded)
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: Crawl results
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/CrawlResult'
                  next_cursor:
                    type: string
                    nullable: true
                    example: eyJjcmVhdGVkX2F0IjoiMjAyNi0wMi0wM1QxMDowMTowMC4wMDBaIiwiaWQiOjV9

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  schemas:
    ScrapeResult:
      type: object
      properties:
        url:
          type: string
          format: uri
        final_url:
          type: string
          format: uri
          nullable: true
        success:
          type: boolean
        status_code:
          type: integer
          nullable: true
        content_type:
          type: string
          nullable: true
        request_used:
          type: string
          enum: [http, chrome]
          nullable: true
        source_type:
          type: string
          enum: [html, pdf, binary, unknown]
        content:
          type: string
          description: Full content if content_inline=true, else empty
        content_inline:
          type: boolean
          description: True if content is included inline
        content_url:
          type: string
          format: uri
          nullable: true
          description: Presigned URL for large text content
        content_expires_at:
          type: string
          format: date-time
          nullable: true
        content_size:
          type: integer
          nullable: true
        bytes_url:
          type: string
          format: uri
          nullable: true
          description: Presigned URL for bytes (return_format=bytes)
        bytes_expires_at:
          type: string
          format: date-time
          nullable: true
        bytes_size:
          type: integer
          nullable: true
        bytes_sha256:
          type: string
          nullable: true
        metadata:
          type: object
          nullable: true
          properties:
            title:
              type: string
            description:
              type: string
        links:
          type: array
          items:
            type: string
            format: uri
        images:
          type: array
          items:
            type: string
            format: uri
        timing_ms:
          type: object
          properties:
            total:
              type: integer
            fetch:
              type: integer
              nullable: true
            render:
              type: integer
              nullable: true
            extract:
              type: integer
              nullable: true
        error:
          type: object
          nullable: true
          properties:
            code:
              type: string
            message:
              type: string

    CrawlResult:
      type: object
      properties:
        url:
          type: string
          format: uri
        final_url:
          type: string
          format: uri
          nullable: true
        success:
          type: boolean
        status_code:
          type: integer
          nullable: true
        content_type:
          type: string
          nullable: true
        request_used:
          type: string
          enum: [http, chrome]
          nullable: true
        source_type:
          type: string
          enum: [html, pdf, binary, unknown]
        content:
          type: string
          description: Always empty (crawl stores to R2)
        content_inline:
          type: boolean
          description: Always false for crawl results
        content_url:
          type: string
          format: uri
          nullable: true
          description: Presigned URL for R2 content
        content_expires_at:
          type: string
          format: date-time
          nullable: true
        content_size:
          type: integer
          nullable: true
        bytes_url:
          type: string
          format: uri
          nullable: true
        bytes_expires_at:
          type: string
          format: date-time
          nullable: true
        bytes_size:
          type: integer
          nullable: true
        bytes_sha256:
          type: string
          nullable: true
        metadata:
          type: object
          nullable: true
        links:
          type: array
          items:
            type: string
            format: uri
        images:
          type: array
          items:
            type: string
            format: uri
        timing_ms:
          type: object
          properties:
            total:
              type: integer
            fetch:
              type: integer
              nullable: true
            render:
              type: integer
              nullable: true
            extract:
              type: integer
              nullable: true
        error:
          type: object
          nullable: true
          properties:
            code:
              type: string
            message:
              type: string
